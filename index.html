<script>
    const LIFF_ID = "2008963829-tIljVU3d"; 
    const API_URL = "https://asia-east1-tim-chatting-project.cloudfunctions.net/tim-chatting-project/liff_api"; 

    let userId = "";

    // 啟動點
    window.onload = () => {
        initLIFF();
    };

    async function initLIFF() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId;
                document.getElementById('user-info').innerHTML = `
                    <img src="${profile.pictureUrl}" alt="icon">
                    <span>哈囉，${profile.displayName}！</span>
                `;
                // 確保拿到 ID 後才執行
                if (userId) fetchTasks();
            }
        } catch (err) {
            console.error("LIFF 載入失敗", err);
        }
    }

    async function fetchTasks() {
        if (!userId) return;

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: "get_tasks", user_id: userId })
            });

            // 先拿純文字，防止 JSON 解析失敗
            const raw = await res.text();
            console.log("GCP 原始回傳：", raw);

            let data;
            try {
                data = JSON.parse(raw);
            } catch (e) {
                console.error("JSON 解析失敗，回傳內容不是 JSON");
                return;
            }

            // 【防彈核心】：如果 data 不是陣列也不是我們要的格式，就給預設值
            // 就算後端回傳 {"debug": "..."}, 這裡也會安全轉成空陣列
            const pending = (data && Array.isArray(data.pending)) ? data.pending : [];
            const history = (data && Array.isArray(data.history)) ? data.history : [];

            renderTasks(pending, "pending-list", true);
            renderTasks(history, "history-list", false);

        } catch (err) {
            console.error("網路連線錯誤:", err);
        }
    }

    function renderTasks(tasks, elementId, showDelete) {
        const list = document.getElementById(elementId);
        
        // 【防彈核心 2】：確保進來的一定是陣列，不然 map() 會崩潰
        const safeTasks = Array.isArray(tasks) ? tasks : [];

        if (safeTasks.length === 0) {
            list.innerHTML = '<div class="no-task">目前沒有任務</div>';
            return;
        }

        list.innerHTML = safeTasks.map(t => `
            <div class="task-item ${!showDelete ? 'history-item' : ''}">
                <div class="task-info">
                    <div style="font-weight:bold;">${t.task || '無標題'}</div>
                    <div class="task-time">${t.remind_at || '時間未知'}</div>
                </div>
                ${showDelete ? `<button class="del-btn" onclick="deleteTask('${t.id}')">刪除</button>` : ''}
            </div>
        `).join('');
    }

    async function addTask() {
        const task = document.getElementById('taskInput').value;
        const timeInput = document.getElementById('timeInput').value;
        if (!task || !timeInput || !userId) return alert("資訊不完整");

        const formattedTime = timeInput.replace('T', ' ') + ':00';
        
        await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: "add_task", user_id: userId, task: task, remind_at: formattedTime })
        });
        
        document.getElementById('taskInput').value = "";
        fetchTasks();
    }

    async function deleteTask(id) {
        if (!confirm("確定要移除嗎？") || !userId) return;
        await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: "delete_task", task_id: id, user_id: userId })
        });
        fetchTasks();
    }
</script>
